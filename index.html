<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sensor Installation Booking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .timeslot-btn {
      margin: 5px;
    }
    .disabled-slot {
      pointer-events: none;
      opacity: 0.6;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4">Book a Sensor Installation Slot</h2>
    <form id="booking-form" class="needs-validation" novalidate>
      <div class="mb-3">
        <label for="name" class="form-label">Full Name</label>
        <input required type="text" class="form-control" id="name" name="name" />
      </div>
      <div class="mb-3">
        <label for="address" class="form-label">Address</label>
        <input required type="text" class="form-control" id="address" name="address" />
      </div>
      <div class="mb-3">
        <label for="phone" class="form-label">Phone Number</label>
        <input required type="text" class="form-control" id="phone" name="phone" />
      </div>
      <div class="mb-3">
        <label class="form-label">Select a Time Slot</label>
        <div id="slot-buttons" class="d-flex flex-wrap"></div>
        <input type="hidden" name="slot" id="slot" required />
      </div>
      <div class="mb-3">
        <label for="notes" class="form-label">Notes (optional)</label>
        <textarea class="form-control" id="notes" name="notes"></textarea>
      </div>
      <button type="submit" class="btn btn-primary" id="submit-btn">Book Now</button>
      <div id="status" class="mt-3"></div>
    </form>
  </div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbx_L5OK4eZbTCAaoF_c3uWBKeVhfoTnUUEXSEMTPlYvPRo9YTRTCd99LIej92xG0wg1/exec';
    const form = document.getElementById('booking-form');
    const slotInput = document.getElementById('slot');
    const status = document.getElementById('status');
    const submitBtn = document.getElementById('submit-btn');

    const availableSlots = [
      "09:00–10:00", "10:00–11:00", "11:00–12:00",
      "13:00–14:00", "14:00–15:00", "15:00–16:00",
      "16:00–17:00"
    ];

    let selectedSlot = null;

    function renderSlots(bookedCounts = {}) {
      const container = document.getElementById('slot-buttons');
      container.innerHTML = '';
      availableSlots.forEach(slot => {
        const count = bookedCounts[slot] || 0;
        const isFull = count >= 3;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `btn btn-outline-primary timeslot-btn ${isFull ? 'disabled-slot' : ''}`;
        btn.textContent = `${slot}${count ? ` (${count}/3)` : ''}`;
        btn.onclick = () => {
          slotInput.value = slot;
          document.querySelectorAll('.timeslot-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        };
        container.appendChild(btn);
      });
    }

    async function fetchBookedSlots() {
      try {
        const res = await fetch('https://YOUR-PROXY-OR-BACKEND-URL/slots');
        const data = await res.json();
        const counts = {};
        for (const entry of data.slots) {
          counts[entry] = (counts[entry] || 0) + 1;
        }
        renderSlots(counts);
      } catch (err) {
        console.error('Could not fetch slot data', err);
        renderSlots();
      }
    }

    form.addEventListener('submit', e => {
      e.preventDefault();

      if (!slotInput.value) {
        alert("Please select a timeslot.");
        return;
      }

      submitBtn.disabled = true;
      status.textContent = "Submitting…";

      const formData = new FormData(form);

      fetch(scriptURL, {
        method: 'POST',
        body: formData
      })
      .then(response => {
        form.reset();
        status.innerHTML = `<div class="alert alert-success">Thank you! Your booking was received.</div>`;
        submitBtn.disabled = false;
        fetchBookedSlots(); // refresh slot status
      })
      .catch(error => {
        console.error('Error!', error.message);
        status.innerHTML = `<div class="alert alert-danger">There was an error. Please try again later.</div>`;
        submitBtn.disabled = false;
      });
    });

    fetchBookedSlots();
  </script>
</body>
</html>
